{% extends "base.html" %}

{% block title %}ç ”ç©¶å†å² - æŠ•èµ„ç ”ç©¶åŠ©æ‰‹{% endblock %}

{% block content %}
<div x-data="{ showReport: null }" class="space-y-6">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div>
        <h1 class="text-2xl font-bold text-gray-900">ç ”ç©¶å†å²</h1>
        <p class="text-gray-500 mt-1">æ‰€æœ‰è‚¡ç¥¨çš„ç ”ç©¶è®°å½•ï¼ŒæŒ‰æ—¶é—´å€’åºæ’åˆ—</p>
    </div>

    {% if history %}
    <!-- ç ”ç©¶è®°å½•åˆ—è¡¨ -->
    <div class="space-y-4">
        {% for h in history %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-6 cursor-pointer hover:bg-gray-50 transition"
                 @click="showReport = showReport === {{ loop.index }} ? null : {{ loop.index }}">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <!-- æ—¥æœŸ -->
                        <div class="text-center">
                            <p class="text-2xl font-bold text-gray-900">{{ h.date[8:10] if h.date else '--' }}</p>
                            <p class="text-sm text-gray-500">{{ h.date[5:7] if h.date else '' }}æœˆ</p>
                        </div>

                        <div class="h-12 w-px bg-gray-200"></div>

                        <!-- è‚¡ç¥¨ä¿¡æ¯ -->
                        <div>
                            <div class="flex items-center space-x-2">
                                <h3 class="font-semibold text-gray-900">{{ h.stock_name }}</h3>
                                {% if h.research_result %}
                                <span class="px-2 py-0.5 text-sm rounded-full
                                    {% if h.research_result.recommendation in ['ä¹°å…¥', 'å¢æŒ'] %}bg-green-100 text-green-700
                                    {% elif h.research_result.recommendation in ['å–å‡º', 'å‡æŒ'] %}bg-red-100 text-red-700
                                    {% else %}bg-gray-100 text-gray-700{% endif %}">
                                    {{ h.research_result.recommendation }}
                                </span>
                                <span class="px-2 py-0.5 text-sm bg-blue-100 text-blue-700 rounded-full">
                                    {{ h.research_result.confidence }}
                                </span>
                                {% endif %}
                            </div>
                            {% if h.research_result and h.research_result.reasoning %}
                            <p class="text-sm text-gray-600 mt-1">{{ h.research_result.reasoning[:100] }}{% if h.research_result.reasoning|length > 100 %}...{% endif %}</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="flex items-center space-x-4">
                        <!-- å½±å“è¯„ä¼° -->
                        {% if h.impact_assessment %}
                        <div class="text-right">
                            <p class="text-sm text-gray-500">è®ºç‚¹å½±å“</p>
                            <p class="font-medium
                                {% if h.research_result and h.research_result.thesis_impact == 'å¼ºåŒ–' %}text-green-600
                                {% elif h.research_result and h.research_result.thesis_impact == 'å‰Šå¼±' %}text-red-600
                                {% else %}text-gray-600{% endif %}">
                                {{ h.research_result.thesis_impact if h.research_result else 'â€”' }}
                            </p>
                        </div>
                        {% endif %}

                        <!-- å±•å¼€å›¾æ ‡ -->
                        <svg class="w-5 h-5 text-gray-400 transform transition-transform"
                             :class="showReport === {{ loop.index }} ? 'rotate-180' : ''"
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- å±•å¼€çš„æŠ¥å‘Šå†…å®¹ -->
            <div x-show="showReport === {{ loop.index }}" x-collapse
                 class="border-t border-gray-100 p-6 bg-gray-50">
                <!-- æ‘˜è¦ä¿¡æ¯ -->
                {% if h.research_result %}
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg">
                        <p class="text-sm text-gray-500">å»ºè®®</p>
                        <p class="font-semibold text-gray-900">{{ h.research_result.recommendation or 'â€”' }}</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg">
                        <p class="text-sm text-gray-500">ä¿¡å¿ƒ</p>
                        <p class="font-semibold text-gray-900">{{ h.research_result.confidence or 'â€”' }}</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg">
                        <p class="text-sm text-gray-500">è®ºç‚¹å½±å“</p>
                        <p class="font-semibold text-gray-900">{{ h.research_result.thesis_impact or 'â€”' }}</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg">
                        <p class="text-sm text-gray-500">ä»“ä½å»ºè®®</p>
                        <p class="font-semibold text-gray-900">{{ h.research_result.position_suggestion or 'â€”' }}</p>
                    </div>
                </div>
                {% endif %}

                <!-- å…³é”®é£é™©ä¸å‚¬åŒ–å‰‚ -->
                {% if h.research_result and (h.research_result.key_risks or h.research_result.key_catalysts) %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    {% if h.research_result.key_risks %}
                    <div class="bg-white p-4 rounded-lg">
                        <p class="text-sm font-medium text-red-600 mb-2">âš ï¸ å…³é”®é£é™©</p>
                        <ul class="text-sm text-gray-700 space-y-1">
                            {% for risk in h.research_result.key_risks %}
                            <li>â€¢ {{ risk }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    {% if h.research_result.key_catalysts %}
                    <div class="bg-white p-4 rounded-lg">
                        <p class="text-sm font-medium text-green-600 mb-2">ğŸš€ å…³é”®å‚¬åŒ–å‰‚</p>
                        <ul class="text-sm text-gray-700 space-y-1">
                            {% for catalyst in h.research_result.key_catalysts %}
                            <li>â€¢ {{ catalyst }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- å®Œæ•´æŠ¥å‘Š -->
                {% if h.full_report %}
                <div class="bg-white rounded-lg p-6">
                    <h4 class="font-medium text-gray-900 mb-4">å®Œæ•´æŠ¥å‘Š</h4>
                    <div class="prose prose-sm max-w-none text-gray-700"
                         x-html="marked.parse(`{{ h.full_report|replace('`', '\\`')|replace('\n', '\\n')|replace('\r', '') }}`)"></div>
                </div>
                {% endif %}

                <!-- ç”¨æˆ·åé¦ˆ -->
                {% if h.user_feedback %}
                <div class="mt-4 bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm font-medium text-blue-900 mb-2">ğŸ“ æˆ‘çš„åé¦ˆ</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <p class="text-gray-500">æˆ‘çš„å†³ç­–</p>
                            <p class="font-semibold
                                {% if h.user_feedback.decision in ['ä¹°å…¥', 'å¢æŒ'] %}text-green-600
                                {% elif h.user_feedback.decision in ['å–å‡º', 'å‡æŒ'] %}text-red-600
                                {% else %}text-gray-900{% endif %}">
                                {{ h.user_feedback.decision }}
                            </p>
                        </div>
                        {% if h.user_feedback.direction_correct %}
                        <div class="col-span-2">
                            <p class="text-gray-500">ç ”ç©¶è¯„ä»·</p>
                            <p class="text-gray-900">{{ h.user_feedback.direction_correct }}</p>
                        </div>
                        {% endif %}
                        {% if h.user_feedback.next_direction %}
                        <div class="col-span-2">
                            <p class="text-gray-500">åç»­ç ”ç©¶æ–¹å‘</p>
                            <p class="text-gray-900">{{ h.user_feedback.next_direction }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% if h.user_feedback.tracking_metrics %}
                    <div class="mt-3">
                        <p class="text-gray-500 text-sm mb-1">è·Ÿè¸ªæŒ‡æ ‡</p>
                        <div class="flex flex-wrap gap-2">
                            {% for metric in h.user_feedback.tracking_metrics %}
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs">{{ metric }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- è·Ÿè¸ªäº‹é¡¹ -->
                {% if h.research_result and h.research_result.follow_up_items %}
                <div class="mt-4 bg-white p-4 rounded-lg">
                    <p class="text-sm font-medium text-gray-900 mb-2">ğŸ“‹ è·Ÿè¸ªäº‹é¡¹</p>
                    <div class="flex flex-wrap gap-2">
                        {% for item in h.research_result.follow_up_items %}
                        <span class="px-3 py-1 bg-blue-50 text-blue-700 rounded-full text-sm">{{ item }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- æŸ¥çœ‹è‚¡ç¥¨è¯¦æƒ…é“¾æ¥ -->
                <div class="mt-4 text-right">
                    <a href="/stock/{{ h.stock_id }}" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                        æŸ¥çœ‹ {{ h.stock_name }} è¯¦æƒ… â†’
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% else %}
    <!-- ç©ºçŠ¶æ€ -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center">
        <div class="text-6xl mb-4">ğŸ“</div>
        <h2 class="text-xl font-semibold text-gray-900 mb-2">æš‚æ— ç ”ç©¶å†å²</h2>
        <p class="text-gray-500 mb-6">å¼€å§‹å¯¹ä½ è·Ÿè¸ªçš„è‚¡ç¥¨è¿›è¡Œæ·±åº¦ç ”ç©¶</p>
        <a href="/stocks" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
            æŸ¥çœ‹è‚¡ç¥¨åˆ—è¡¨
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}
