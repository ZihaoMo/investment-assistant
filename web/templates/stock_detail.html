{% extends "base.html" %}

{% block title %}{{ playbook.stock_name if playbook else 'è‚¡ç¥¨è¯¦æƒ…' }} - æŠ•èµ„ç ”ç©¶åŠ©æ‰‹{% endblock %}

{% block content %}
<div x-data="stockDetail()" class="space-y-6">
    <!-- è¿”å›é“¾æ¥ -->
    <a href="/stocks" class="inline-flex items-center text-gray-500 hover:text-gray-700 text-sm">
        â† è¿”å›è‚¡ç¥¨åˆ—è¡¨
    </a>

    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">{{ playbook.stock_name if playbook else 'è‚¡ç¥¨è¯¦æƒ…' }}</h1>
            {% if playbook and playbook.ticker %}
            <p class="text-gray-500">{{ playbook.ticker }}</p>
            {% endif %}
        </div>
        <div class="flex space-x-3">
            <button @click="openResearchModal()"
                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                å‘èµ·æ·±åº¦ç ”ç©¶
            </button>
            <button @click="editMode = !editMode"
                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                <span x-text="editMode ? 'å–æ¶ˆ' : 'ç¼–è¾‘ Playbook'"></span>
            </button>
        </div>
    </div>

    <!-- Playbook ä¿¡æ¯ -->
    <div x-show="!editMode" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- å·¦ä¾§ï¼šæ ¸å¿ƒä¿¡æ¯ -->
        <div class="lg:col-span-2 space-y-6">
            <!-- æ ¸å¿ƒè®ºç‚¹ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">æ ¸å¿ƒè®ºç‚¹</h2>
                {% if playbook and playbook.core_thesis %}
                <div class="space-y-4">
                    <div>
                        <p class="text-sm font-medium text-gray-500">ä¸€å¥è¯æ€»ç»“</p>
                        <p class="text-lg text-gray-900">{{ playbook.core_thesis.summary }}</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-2">å…³é”®è¦ç‚¹</p>
                        <div class="space-y-2">
                            {% for point in playbook.core_thesis.key_points %}
                            <div class="flex items-start space-x-2">
                                <span class="text-blue-500 mt-1">â€¢</span>
                                <span class="text-gray-700">{{ point }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% if playbook.core_thesis.market_gap %}
                    <div>
                        <p class="text-sm font-medium text-gray-500">å¸‚åœºè®¤çŸ¥å·®</p>
                        <p class="text-gray-900">{{ playbook.core_thesis.market_gap }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- éªŒè¯ä¸å¤±æ•ˆ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">âœ… éªŒè¯ä¿¡å·</h2>
                    {% if playbook and playbook.validation_signals %}
                    <ul class="space-y-2">
                        {% for signal in playbook.validation_signals %}
                        <li class="flex items-start space-x-2">
                            <span class="text-green-500 mt-1">âœ“</span>
                            <span class="text-gray-700">{{ signal }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">âš ï¸ å¤±æ•ˆæ¡ä»¶</h2>
                    {% if playbook and playbook.invalidation_triggers %}
                    <ul class="space-y-2">
                        {% for trigger in playbook.invalidation_triggers %}
                        <li class="flex items-start space-x-2">
                            <span class="text-red-500 mt-1">âœ—</span>
                            <span class="text-gray-700">{{ trigger }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </div>

            <!-- ç ”ç©¶å†å² -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">ç ”ç©¶å†å²</h2>
                {% if history %}
                <div class="space-y-4">
                    {% for h in history %}
                    <div class="border rounded-lg overflow-hidden {% if h.is_milestone %}border-amber-300 bg-amber-50/30{% else %}border-gray-200{% endif %}"
                         x-data="{ isMilestone: {{ 'true' if h.is_milestone else 'false' }} }">
                        <div class="p-4 hover:bg-gray-50 cursor-pointer"
                             @click="expandedHistory = expandedHistory === {{ loop.index }} ? null : {{ loop.index }}">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <!-- é‡Œç¨‹ç¢‘æ ‡è®° -->
                                    <div class="relative text-center min-w-[50px]">
                                        <p class="text-lg font-bold text-gray-900">{{ h.date[8:10] if h.date else '--' }}</p>
                                        <p class="text-xs text-gray-500">{{ h.date[5:7] if h.date else '' }}æœˆ</p>
                                        <span x-show="isMilestone" class="absolute -top-1 -right-1 text-amber-500 text-sm" title="é‡Œç¨‹ç¢‘">&#9733;</span>
                                    </div>
                                    <div>
                                        <div class="flex items-center space-x-2">
                                            {% if h.research_result %}
                                            <span class="px-2 py-0.5 text-sm rounded-full
                                                {% if h.research_result.recommendation in ['ä¹°å…¥', 'å¢æŒ'] %}bg-green-100 text-green-700
                                                {% elif h.research_result.recommendation in ['å–å‡º', 'å‡æŒ'] %}bg-red-100 text-red-700
                                                {% else %}bg-gray-100 text-gray-700{% endif %}">
                                                {{ h.research_result.recommendation }}
                                            </span>
                                            <span class="text-sm text-gray-500">({{ h.research_result.confidence }})</span>
                                            {% endif %}
                                            <!-- é‡Œç¨‹ç¢‘å¾½ç«  -->
                                            <span x-show="isMilestone" class="px-2 py-0.5 text-xs rounded-full bg-amber-100 text-amber-700">
                                                é‡Œç¨‹ç¢‘
                                            </span>
                                        </div>
                                        {% if h.research_result and h.research_result.key_finding %}
                                        <p class="text-sm text-gray-600 mt-1">{{ h.research_result.key_finding }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <!-- é‡Œç¨‹ç¢‘åˆ‡æ¢æŒ‰é’® -->
                                    <button @click.stop="
                                        fetch('/api/research/{{ stock_id }}/milestone/{{ h.id }}', { method: 'POST' })
                                            .then(r => r.json())
                                            .then(d => { isMilestone = d.is_milestone; })
                                    " class="p-1.5 rounded-full hover:bg-gray-200 transition"
                                       :class="isMilestone ? 'text-amber-500' : 'text-gray-400'"
                                       :title="isMilestone ? 'å–æ¶ˆé‡Œç¨‹ç¢‘' : 'æ ‡è®°ä¸ºé‡Œç¨‹ç¢‘'">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                        </svg>
                                    </button>
                                    <!-- ç”¨æˆ·åé¦ˆæ ‡è®° -->
                                    {% if h.user_feedback %}
                                    <span class="px-2 py-1 text-xs rounded-full
                                        {% if h.user_feedback.decision == 'ä¹°å…¥' %}bg-green-100 text-green-700
                                        {% elif h.user_feedback.decision == 'å–å‡º' %}bg-red-100 text-red-700
                                        {% else %}bg-blue-100 text-blue-700{% endif %}">
                                        æˆ‘çš„å†³ç­–: {{ h.user_feedback.decision }}
                                    </span>
                                    {% endif %}
                                    <span class="text-gray-400">{{ 'â–¼' if expandedHistory == loop.index else 'â–¶' }}</span>
                                </div>
                            </div>
                        </div>
                        <!-- å±•å¼€å†…å®¹ -->
                        <div x-show="expandedHistory === {{ loop.index }}" x-collapse class="border-t border-gray-200 bg-gray-50 p-4">
                            {% if h.user_feedback %}
                            <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                                <p class="text-sm font-medium text-blue-900 mb-2">ğŸ“ æˆ‘çš„åé¦ˆ</p>
                                <div class="text-sm text-blue-800 space-y-1">
                                    <p><strong>å†³ç­–:</strong> {{ h.user_feedback.decision }}</p>
                                    {% if h.user_feedback.direction_correct %}
                                    <p><strong>ç ”ç©¶è¯„ä»·:</strong> {{ h.user_feedback.direction_correct }}</p>
                                    {% endif %}
                                    {% if h.user_feedback.tracking_metrics %}
                                    <p><strong>è·Ÿè¸ªæŒ‡æ ‡:</strong> {{ h.user_feedback.tracking_metrics | join(', ') }}</p>
                                    {% endif %}
                                    {% if h.user_feedback.next_direction %}
                                    <p><strong>åç»­æ–¹å‘:</strong> {{ h.user_feedback.next_direction }}</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            {% if h.full_report %}
                            <div class="prose prose-sm max-w-none text-gray-700 max-h-96 overflow-y-auto"
                                 x-html="marked.parse(`{{ h.full_report|replace('`', '\\`')|replace('\n', '\\n')|replace('\r', '') }}`)"></div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500">æš‚æ— ç ”ç©¶å†å²</p>
                {% endif %}
            </div>
        </div>

        <!-- å³ä¾§ï¼šç›¸å…³ä¿¡æ¯ -->
        <div class="space-y-6">
            <!-- ç›¸å…³å®ä½“ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">ç›¸å…³å®ä½“</h2>
                {% if playbook and playbook.related_entities %}
                <div class="flex flex-wrap gap-2">
                    {% for entity in playbook.related_entities %}
                    <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm">{{ entity }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- æŒç»­è·Ÿè¸ªæŒ‡æ ‡ -->
            {% if playbook and playbook.tracking_metrics %}
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">ğŸ“Š æŒç»­è·Ÿè¸ªæŒ‡æ ‡</h2>
                <ul class="space-y-2">
                    {% for metric in playbook.tracking_metrics %}
                    <li class="flex items-center space-x-2 text-sm">
                        <span class="text-blue-500">â€¢</span>
                        <span class="text-gray-700">{{ metric }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- æ“ä½œè®¡åˆ’ -->
            {% if playbook and playbook.operation_plan %}
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">æ“ä½œè®¡åˆ’</h2>
                <div class="space-y-3 text-sm">
                    {% if playbook.operation_plan.holding_period %}
                    <div class="flex justify-between">
                        <span class="text-gray-500">æŒæœ‰å‘¨æœŸ</span>
                        <span class="text-gray-900">{{ playbook.operation_plan.holding_period }}</span>
                    </div>
                    {% endif %}
                    {% if playbook.operation_plan.position_size %}
                    <div class="flex justify-between">
                        <span class="text-gray-500">ä»“ä½æ¯”ä¾‹</span>
                        <span class="text-gray-900">{{ playbook.operation_plan.position_size }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ç¼–è¾‘æ¨¡å¼ -->
    <div x-show="editMode" class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">ç¼–è¾‘ Playbook</h2>
        <textarea x-model="jsonContent"
            class="w-full h-96 p-4 font-mono text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
        <div class="flex justify-end space-x-3 mt-4">
            <button @click="editMode = false" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">å–æ¶ˆ</button>
            <button @click="savePlaybook()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ä¿å­˜</button>
        </div>
    </div>

    <!-- ==================== æ·±åº¦ç ”ç©¶å¼¹çª— ==================== -->
    <div x-show="researchModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4 py-8">
            <div class="fixed inset-0 bg-black opacity-50" @click="closeResearchModal()"></div>
            <div class="relative bg-white rounded-xl shadow-xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                <!-- å¤´éƒ¨ -->
                <div class="p-6 border-b border-gray-200 flex-shrink-0">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">æ·±åº¦ç ”ç©¶: {{ playbook.stock_name if playbook else '' }}</h2>
                            <p class="text-gray-500 text-sm mt-1" x-text="stepDescriptions[currentStep]"></p>
                        </div>
                        <button @click="closeResearchModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
                    <div class="flex items-center space-x-2 mt-4">
                        <template x-for="(step, index) in steps" :key="index">
                            <div class="flex items-center">
                                <div class="flex items-center justify-center w-8 h-8 rounded-full text-sm font-medium"
                                     :class="currentStep > index ? 'bg-green-500 text-white' :
                                             currentStep === index ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'">
                                    <span x-show="currentStep <= index" x-text="index + 1"></span>
                                    <span x-show="currentStep > index">âœ“</span>
                                </div>
                                <span class="ml-2 text-sm" :class="currentStep >= index ? 'text-gray-900' : 'text-gray-400'" x-text="step"></span>
                                <div x-show="index < steps.length - 1" class="w-8 h-px bg-gray-300 mx-2"></div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- å†…å®¹åŒºåŸŸ -->
                <div class="flex-1 overflow-y-auto p-6">
                    <!-- åŠ è½½çŠ¶æ€ -->
                    <div x-show="loading" class="flex items-center justify-center h-64">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mx-auto mb-4"></div>
                            <p class="text-gray-600" x-text="loadingText"></p>
                        </div>
                    </div>

                    <!-- Step 1: è®¾ç½®å‚æ•° -->
                    <div x-show="!loading && currentStep === 0" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- æ—¶é—´èŒƒå›´ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Environment æœç´¢æ—¶é—´èŒƒå›´</label>
                                <div class="flex space-x-2">
                                    <select x-model="daysPreset" @change="if(daysPreset !== 'custom') days = daysPreset"
                                        class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="3">è¿‡å» 3 å¤©</option>
                                        <option value="7">è¿‡å» 7 å¤©</option>
                                        <option value="14">è¿‡å» 14 å¤©</option>
                                        <option value="30">è¿‡å» 30 å¤©</option>
                                        <option value="custom">è‡ªå®šä¹‰</option>
                                    </select>
                                    <div x-show="daysPreset === 'custom'" class="flex items-center space-x-2">
                                        <input type="number" x-model="days" min="1" max="365"
                                            class="w-20 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                            placeholder="å¤©æ•°">
                                        <span class="text-gray-500">å¤©</span>
                                    </div>
                                </div>
                            </div>

                            <!-- æ–‡ä»¶ä¸Šä¼  -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ä¸Šä¼ é¢å¤–æ–‡ä»¶ (å¯é€‰)</label>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-blue-500 transition cursor-pointer"
                                     @click="$refs.fileInput.click()">
                                    <input type="file" x-ref="fileInput" @change="handleFileUpload($event)" class="hidden" multiple accept=".pdf,.txt,.md,.png,.jpg,.jpeg">
                                    <p class="text-gray-500 text-sm">ç‚¹å‡»ä¸Šä¼ ç ”æŠ¥ã€æ–°é—»æˆªå›¾ç­‰</p>
                                    <p class="text-gray-400 text-xs mt-1">æ”¯æŒ PDFã€TXTã€MDã€å›¾ç‰‡</p>
                                </div>
                                <div x-show="uploadedFiles.length > 0" class="mt-2 space-y-1">
                                    <template x-for="(file, index) in uploadedFiles" :key="index">
                                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded text-sm">
                                            <span x-text="file.name"></span>
                                            <button @click="removeFile(index)" class="text-red-500 hover:text-red-600">Ã—</button>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>

                        <!-- ä¹‹å‰çš„ç ”ç©¶ä¸Šä¸‹æ–‡ -->
                        {% if history %}
                        <div class="p-4 bg-yellow-50 rounded-lg">
                            <p class="text-sm font-medium text-yellow-800 mb-2">ğŸ“š ä¹‹å‰çš„ç ”ç©¶ä¸Šä¸‹æ–‡</p>
                            <p class="text-sm text-yellow-700">
                                ç³»ç»Ÿå°†å‚è€ƒä¹‹å‰ {{ history|length }} æ¬¡ç ”ç©¶çš„ç»“æœå’Œä½ çš„åé¦ˆï¼Œç¡®ä¿ç ”ç©¶æ–¹å‘çš„è¿ç»­æ€§ã€‚
                            </p>
                            {% if history[0].user_feedback %}
                            <div class="mt-2 p-2 bg-white rounded text-sm">
                                <p class="text-gray-600">ä¸Šæ¬¡åé¦ˆ: {{ history[0].user_feedback.feedback_on_research or 'æ— ' }}</p>
                                <p class="text-gray-600">ä¸Šæ¬¡å†³ç­–: {{ history[0].user_feedback.final_decision or 'æ— ' }}</p>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <button @click="collectEnvironment()" class="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                            å¼€å§‹é‡‡é›† Environment
                        </button>
                    </div>

                    <!-- Step 2: å±•ç¤ºé‡‡é›†ç»“æœ + è¯„ä¼° -->
                    <div x-show="!loading && currentStep === 1" class="space-y-6">
                        <!-- å› æœé€»è¾‘ 1: ä¸ºä»€ä¹ˆè¿™ä¸ªå†…å®¹å€¼å¾—è¿›è¡Œ Deep Researchï¼Ÿ -->
                        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                            <h3 class="font-medium text-amber-900 mb-3">ğŸ’¡ Step 1 å› æœé€»è¾‘ï¼šä¸ºä»€ä¹ˆè¿™äº›å†…å®¹å€¼å¾—å…³æ³¨ï¼Ÿ</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex items-start space-x-2">
                                    <span class="text-amber-600 font-bold">â†’</span>
                                    <p class="text-gray-700">
                                        åœ¨è¿‡å» <strong x-text="days"></strong> å¤©å†…ï¼Œé€šè¿‡<strong>6ä¸ªç»´åº¦</strong>çš„å¤šå±‚æ¬¡æœç´¢ï¼Œ
                                        é‡‡é›†åˆ° <strong x-text="news.length"></strong> æ¡ä¸ <strong>{{ playbook.stock_name if playbook else 'è¯¥è‚¡ç¥¨' }}</strong> ç›¸å…³çš„å¸‚åœºåŠ¨æ€ã€‚
                                    </p>
                                </div>
                                <div class="flex items-start space-x-2">
                                    <span class="text-amber-600 font-bold">â†’</span>
                                    <p class="text-gray-700">
                                        å…¶ä¸­é«˜é‡è¦æ€§äº‹ä»¶ <strong x-text="news.filter(n => n.importance === 'é«˜').length"></strong> æ¡ï¼Œ
                                        ä¸­é‡è¦æ€§ <strong x-text="news.filter(n => n.importance === 'ä¸­').length"></strong> æ¡ã€‚
                                    </p>
                                </div>
                                <div x-show="uploadedFilesAnalysis.length > 0" class="flex items-start space-x-2">
                                    <span class="text-amber-600 font-bold">â†’</span>
                                    <p class="text-gray-700">
                                        ä½ è¿˜ä¸Šä¼ äº† <strong x-text="uploadedFilesAnalysis.length"></strong> ä»½é¢å¤–èµ„æ–™ï¼Œè¿™äº›å°†çº³å…¥è¯„ä¼°èŒƒå›´ã€‚
                                    </p>
                                </div>
                                <div class="mt-3 p-2 bg-amber-100 rounded text-amber-800">
                                    <strong>ä¸‹ä¸€æ­¥ï¼š</strong>ç‚¹å‡»"è¿›è¡Œä¸‰ç»´åº¦è¯„ä¼°"ï¼Œç³»ç»Ÿå°†åˆ†æè¿™äº›å˜åŒ–ä¸ä½ çš„æŠ•èµ„é€»è¾‘ï¼ˆPlaybookï¼‰å’Œå†å²ç ”ç©¶çš„å…³è”ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ·±åº¦ç ”ç©¶ã€‚
                                </div>
                            </div>
                        </div>

                        <!-- æœç´¢è­¦å‘Š -->
                        <template x-if="searchMetadata && searchMetadata.search_warnings && searchMetadata.search_warnings.length > 0">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                                <div class="flex items-start space-x-2">
                                    <span class="text-yellow-600 text-lg">&#9888;</span>
                                    <div>
                                        <p class="font-medium text-yellow-800">éƒ¨åˆ†æœç´¢ç»´åº¦ä¸å¯ç”¨</p>
                                        <p class="text-sm text-yellow-700 mt-1">ä»¥ä¸‹æœç´¢ç»´åº¦å¤±è´¥ï¼Œç»“æœå¯èƒ½ä¸å®Œæ•´ï¼š</p>
                                        <ul class="text-sm text-yellow-600 mt-2 space-y-1">
                                            <template x-for="warning in searchMetadata.search_warnings" :key="warning">
                                                <li class="flex items-center space-x-1">
                                                    <span>â€¢</span>
                                                    <span x-text="warning"></span>
                                                </li>
                                            </template>
                                        </ul>
                                        <p class="text-xs text-yellow-600 mt-2">
                                            æˆåŠŸ <span x-text="searchMetadata.successful_dimensions"></span>/<span x-text="searchMetadata.total_dimensions"></span> ä¸ªç»´åº¦
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- é‡‡é›†åˆ°çš„æ–°é—» -->
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <h3 class="font-medium text-gray-900 mb-3">ğŸ“° é‡‡é›†åˆ° <span x-text="news.length"></span> æ¡å¸‚åœºåŠ¨æ€ï¼ˆå¤šç»´åº¦æœç´¢ï¼‰</h3>

                            <!-- ç»´åº¦ç»Ÿè®¡ -->
                            <div class="flex flex-wrap gap-2 mb-3">
                                <template x-for="dim in [...new Set(news.map(n => n.dimension).filter(Boolean))]" :key="dim">
                                    <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-700"
                                          x-text="dim + ' (' + news.filter(n => n.dimension === dim).length + ')'"></span>
                                </template>
                            </div>

                            <div class="max-h-64 overflow-y-auto space-y-2">
                                <template x-for="(item, index) in news" :key="index">
                                    <div class="flex items-start space-x-3 p-2 bg-gray-50 rounded">
                                        <div class="flex flex-col items-center space-y-1 flex-shrink-0">
                                            <span class="px-2 py-0.5 text-xs rounded-full"
                                                  :class="item.importance === 'é«˜' ? 'bg-red-100 text-red-700' :
                                                          item.importance === 'ä¸­' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'"
                                                  x-text="item.importance"></span>
                                            <span class="text-xs text-gray-400" x-text="item.dimension || ''"></span>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm text-gray-900" x-text="item.title"></p>
                                            <p class="text-xs text-gray-600 mt-1" x-text="item.summary || ''"></p>
                                            <p class="text-xs text-gray-400 mt-1" x-text="item.date"></p>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- ä¸Šä¼ æ–‡ä»¶çš„åˆ†æç»“æœ -->
                        <div x-show="uploadedFilesAnalysis.length > 0" class="bg-white border border-gray-200 rounded-lg p-4">
                            <h3 class="font-medium text-gray-900 mb-3">ğŸ“ ä¸Šä¼ æ–‡ä»¶åˆ†æ (<span x-text="uploadedFilesAnalysis.length"></span> ä¸ª)</h3>
                            <div class="space-y-3">
                                <template x-for="(file, index) in uploadedFilesAnalysis" :key="index">
                                    <div class="p-3 bg-blue-50 rounded-lg">
                                        <p class="font-medium text-gray-900 text-sm" x-text="file.filename"></p>
                                        <p class="text-sm text-gray-700 mt-1" x-text="file.summary"></p>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <button @click="assessImpact()" class="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                            è¿›è¡Œä¸‰ç»´åº¦è¯„ä¼°
                        </button>
                    </div>

                    <!-- Step 3: å±•ç¤ºè¯„ä¼°ç»“æœ + ç ”ç©¶è®¡åˆ’ -->
                    <div x-show="!loading && currentStep === 2" class="space-y-6">
                        <!-- å› æœé€»è¾‘ 2: ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ç§æ–¹å¼è¿›è¡Œ Deep Researchï¼Ÿ -->
                        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                            <h3 class="font-medium text-amber-900 mb-3">ğŸ’¡ Step 2 å› æœé€»è¾‘ï¼šä¸ºä»€ä¹ˆè¦åšè¿™ä¸ªç ”ç©¶ï¼Ÿä¸ºä»€ä¹ˆè¿™æ ·åšï¼Ÿ</h3>

                            <!-- å› æœé“¾æ¡ -->
                            <div class="space-y-4 text-sm">
                                <!-- åŸå› 1: ç¯å¢ƒå˜åŒ– -->
                                <div class="p-3 bg-white rounded-lg border-l-4 border-blue-400">
                                    <p class="font-medium text-blue-800 mb-2">ğŸ“Š åŸå› ä¸€ï¼šç¯å¢ƒå‘ç”Ÿäº†ä»€ä¹ˆå˜åŒ–ï¼Ÿ</p>
                                    <div class="space-y-1">
                                        <template x-for="(s, i) in (assessment?.dimension_analysis?.environment_signals?.signal_vs_noise || []).filter(x => x.classification === 'ä¿¡å·').slice(0, 3)" :key="i">
                                            <p class="text-gray-700 flex items-start">
                                                <span class="text-blue-500 mr-2">â€¢</span>
                                                <span><strong x-text="s.event"></strong> â€” <span class="text-gray-500" x-text="s.reasoning"></span></span>
                                            </p>
                                        </template>
                                        <p x-show="(assessment?.dimension_analysis?.environment_signals?.signal_vs_noise || []).filter(x => x.classification === 'ä¿¡å·').length === 0"
                                           class="text-gray-500">æš‚æ— æ˜æ˜¾çš„é‡è¦ä¿¡å·</p>
                                    </div>
                                </div>

                                <!-- åŸå› 2: ä¸æŠ•èµ„é€»è¾‘çš„å…³è” -->
                                <div class="p-3 bg-white rounded-lg border-l-4 border-purple-400">
                                    <p class="font-medium text-purple-800 mb-2">ğŸ¯ åŸå› äºŒï¼šè¿™äº›å˜åŒ–ä¸ä½ çš„æŠ•èµ„é€»è¾‘æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</p>
                                    <div class="space-y-2">
                                        <p class="text-gray-700">
                                            <strong>è®ºç‚¹å½±å“ï¼š</strong>
                                            <span class="px-2 py-0.5 rounded-full text-xs"
                                                  :class="{
                                                      'bg-green-100 text-green-700': assessment?.dimension_analysis?.thesis_impact?.core_thesis_status === 'å¼ºåŒ–',
                                                      'bg-red-100 text-red-700': assessment?.dimension_analysis?.thesis_impact?.core_thesis_status === 'åŠ¨æ‘‡',
                                                      'bg-yellow-100 text-yellow-700': assessment?.dimension_analysis?.thesis_impact?.core_thesis_status === 'å‰Šå¼±',
                                                      'bg-gray-100 text-gray-700': true
                                                  }"
                                                  x-text="assessment?.dimension_analysis?.thesis_impact?.core_thesis_status || 'æ— æ˜æ˜¾å½±å“'"></span>
                                        </p>
                                        <template x-if="assessment?.dimension_analysis?.thesis_impact?.key_points_affected?.length > 0">
                                            <div class="pl-4 space-y-1">
                                                <template x-for="(p, i) in assessment?.dimension_analysis?.thesis_impact?.key_points_affected?.slice(0, 2)" :key="i">
                                                    <p class="text-gray-600">
                                                        â†’ <strong x-text="p.point"></strong>: <span x-text="p.impact"></span>
                                                        <span class="text-xs px-1 rounded" :class="p.severity === 'é«˜' ? 'bg-red-100 text-red-600' : 'bg-gray-100 text-gray-500'" x-text="'(' + p.severity + ')'"></span>
                                                    </p>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- åŸå› 3: ä¸å†å²ç ”ç©¶çš„è¿ç»­æ€§ -->
                                <div class="p-3 bg-white rounded-lg border-l-4 border-green-400">
                                    <p class="font-medium text-green-800 mb-2">ğŸ“š åŸå› ä¸‰ï¼šä¸ä¹‹å‰çš„ç ”ç©¶æœ‰ä»€ä¹ˆè”ç³»ï¼Ÿ</p>
                                    <p class="text-gray-700" x-text="assessment?.dimension_analysis?.historical_context?.last_research_conclusion || 'è¿™æ˜¯é¦–æ¬¡ç ”ç©¶ï¼Œæš‚æ— å†å²ä¸Šä¸‹æ–‡'"></p>
                                    <template x-if="assessment?.dimension_analysis?.historical_context?.new_developments_on_followups?.length > 0">
                                        <div class="mt-2 pl-4">
                                            <p class="text-xs text-gray-500 mb-1">ä¹‹å‰å¾…è·Ÿè¿›äº‹é¡¹çš„æ–°è¿›å±•ï¼š</p>
                                            <template x-for="(d, i) in assessment?.dimension_analysis?.historical_context?.new_developments_on_followups?.slice(0, 2)" :key="i">
                                                <p class="text-green-700" x-text="'âœ“ ' + d"></p>
                                            </template>
                                        </div>
                                    </template>
                                </div>

                                <!-- ç»“è®º -->
                                <div class="p-3 bg-amber-100 rounded-lg">
                                    <p class="font-medium text-amber-800">
                                        <span x-show="assessment?.judgment?.needs_deep_research">âœ… ç»¼ä¸Šæ‰€è¿°ï¼Œå»ºè®®è¿›è¡Œæ·±åº¦ç ”ç©¶</span>
                                        <span x-show="!assessment?.judgment?.needs_deep_research">â¸ï¸ ç»¼ä¸Šæ‰€è¿°ï¼Œæš‚æ—¶ä¸éœ€è¦æ·±åº¦ç ”ç©¶</span>
                                    </p>
                                    <p class="text-amber-700 mt-1" x-text="assessment?.conclusion?.summary || ''"></p>
                                </div>
                            </div>
                        </div>

                        <!-- æ˜¯å¦éœ€è¦ç ”ç©¶ -->
                        <div class="p-4 rounded-lg" :class="assessment?.judgment?.needs_deep_research ? 'bg-green-50' : 'bg-gray-50'">
                            <div class="flex items-center space-x-3">
                                <span class="text-3xl" x-text="assessment?.judgment?.needs_deep_research ? 'âœ…' : 'â¸ï¸'"></span>
                                <div>
                                    <h3 class="font-bold text-lg" x-text="assessment?.judgment?.needs_deep_research ? 'å»ºè®®è¿›è¡Œæ·±åº¦ç ”ç©¶' : 'æš‚ä¸éœ€è¦æ·±åº¦ç ”ç©¶'"></h3>
                                    <p class="text-gray-600" x-text="assessment?.conclusion?.summary || ''"></p>
                                </div>
                            </div>
                            <div class="mt-2 flex items-center space-x-4 text-sm">
                                <span class="text-gray-500">ä¿¡å¿ƒ: <strong x-text="assessment?.judgment?.confidence || 'â€”'"></strong></span>
                                <span class="text-gray-500">ç´§è¿«æ€§: <strong x-text="assessment?.judgment?.urgency || 'â€”'"></strong></span>
                            </div>
                        </div>

                        <!-- ä¸‰ç»´åº¦åˆ†æè¯¦æƒ… -->
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <h3 class="font-medium text-gray-900 mb-3 flex items-center justify-between">
                                <span>ğŸ“Š ä¸‰ç»´åº¦åˆ†æ</span>
                                <button @click="showDimensionDetail = !showDimensionDetail" class="text-blue-600 text-sm">
                                    <span x-text="showDimensionDetail ? 'æ”¶èµ·' : 'å±•å¼€è¯¦æƒ…'"></span>
                                </button>
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-medium text-gray-700 mb-1">å†å²ç ”ç©¶</p>
                                    <p class="text-gray-600" x-text="assessment?.dimension_analysis?.historical_context?.last_research_conclusion || 'æš‚æ— å†å²'"></p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-medium text-gray-700 mb-1">è®ºç‚¹å½±å“</p>
                                    <p class="font-semibold" :class="{
                                        'text-green-600': assessment?.dimension_analysis?.thesis_impact?.core_thesis_status === 'å¼ºåŒ–',
                                        'text-red-600': assessment?.dimension_analysis?.thesis_impact?.core_thesis_status === 'åŠ¨æ‘‡',
                                        'text-yellow-600': assessment?.dimension_analysis?.thesis_impact?.core_thesis_status === 'å‰Šå¼±',
                                        'text-gray-600': true
                                    }" x-text="assessment?.dimension_analysis?.thesis_impact?.core_thesis_status || 'â€”'"></p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="font-medium text-gray-700 mb-1">å¸‚åœºé¢„æœŸå·®</p>
                                    <p class="text-gray-600" x-text="assessment?.dimension_analysis?.environment_signals?.market_expectation_gap || 'â€”'"></p>
                                </div>
                            </div>
                            <!-- å±•å¼€çš„è¯¦æƒ… -->
                            <div x-show="showDimensionDetail" x-collapse class="mt-4 space-y-4">
                                <!-- ä¿¡å· vs å™ªéŸ³ -->
                                <div x-show="assessment?.dimension_analysis?.environment_signals?.signal_vs_noise?.length > 0">
                                    <p class="font-medium text-gray-700 mb-2">ä¿¡å· vs å™ªéŸ³</p>
                                    <div class="space-y-2">
                                        <template x-for="(s, i) in assessment?.dimension_analysis?.environment_signals?.signal_vs_noise || []" :key="i">
                                            <div class="flex items-start space-x-2 p-2 bg-gray-50 rounded">
                                                <span class="px-2 py-0.5 text-xs rounded-full flex-shrink-0"
                                                      :class="s.classification === 'ä¿¡å·' ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-600'"
                                                      x-text="s.classification"></span>
                                                <div>
                                                    <p class="text-gray-900 text-sm" x-text="s.event"></p>
                                                    <p class="text-gray-500 text-xs" x-text="s.reasoning"></p>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                                <!-- ä¸€é˜¶/äºŒé˜¶æ•ˆåº” -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="font-medium text-gray-700 mb-1">ä¸€é˜¶æ•ˆåº”</p>
                                        <ul class="text-sm text-gray-600 space-y-1">
                                            <template x-for="(e, i) in assessment?.dimension_analysis?.environment_signals?.first_order_effects || []" :key="i">
                                                <li class="flex items-start"><span class="text-blue-500 mr-1">â€¢</span><span x-text="e"></span></li>
                                            </template>
                                        </ul>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-700 mb-1">äºŒé˜¶æ•ˆåº”</p>
                                        <ul class="text-sm text-gray-600 space-y-1">
                                            <template x-for="(e, i) in assessment?.dimension_analysis?.environment_signals?.second_order_effects || []" :key="i">
                                                <li class="flex items-start"><span class="text-purple-500 mr-1">â€¢</span><span x-text="e"></span></li>
                                            </template>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å…³é”®é£é™©/æœºä¼š -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-4 bg-red-50 border border-red-100 rounded-lg">
                                <p class="text-sm font-medium text-red-700 mb-1">âš ï¸ å…³é”®é£é™©</p>
                                <p class="text-red-900" x-text="assessment?.conclusion?.key_risk || 'â€”'"></p>
                            </div>
                            <div class="p-4 bg-green-50 border border-green-100 rounded-lg">
                                <p class="text-sm font-medium text-green-700 mb-1">ğŸ¯ å…³é”®æœºä¼š</p>
                                <p class="text-green-900" x-text="assessment?.conclusion?.key_opportunity || 'â€”'"></p>
                            </div>
                        </div>

                        <!-- ç ”ç©¶è®¡åˆ’è¯¦æƒ… -->
                        <div x-show="assessment?.research_plan" class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                            <div class="p-4 bg-blue-50 border-b border-blue-100">
                                <h3 class="font-medium text-blue-900">ğŸ“‹ ç ”ç©¶è®¡åˆ’</h3>
                                <p class="text-sm text-blue-700 mt-1" x-text="assessment?.research_plan?.research_objective || ''"></p>
                            </div>
                            <div class="p-4 space-y-4">
                                <!-- å¾…éªŒè¯å‡è®¾ -->
                                <div x-show="assessment?.research_plan?.hypothesis_to_test?.length > 0">
                                    <p class="font-medium text-gray-700 mb-2">ğŸ”¬ å¾…éªŒè¯å‡è®¾</p>
                                    <div class="space-y-3">
                                        <template x-for="(h, i) in assessment?.research_plan?.hypothesis_to_test || []" :key="i">
                                            <div class="p-3 bg-gray-50 rounded-lg border-l-4 border-blue-400">
                                                <p class="font-medium text-gray-900" x-text="h.hypothesis"></p>
                                                <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
                                                    <div class="text-green-700">
                                                        <span class="font-medium">è‹¥ä¸ºçœŸ:</span>
                                                        <span x-text="h.if_true_implication"></span>
                                                    </div>
                                                    <div class="text-red-700">
                                                        <span class="font-medium">è‹¥ä¸ºå‡:</span>
                                                        <span x-text="h.if_false_implication"></span>
                                                    </div>
                                                </div>
                                                <p class="mt-1 text-sm text-gray-500">
                                                    <span class="font-medium">éªŒè¯æ–¹æ³•:</span>
                                                    <span x-text="h.how_to_verify"></span>
                                                </p>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- ç ”ç©¶æ¨¡å— -->
                                <div x-show="assessment?.research_plan?.research_modules?.length > 0">
                                    <p class="font-medium text-gray-700 mb-2">ğŸ“š ç ”ç©¶æ¨¡å—</p>
                                    <div class="space-y-3">
                                        <template x-for="(m, i) in assessment?.research_plan?.research_modules || []" :key="i">
                                            <div class="p-3 bg-gray-50 rounded-lg">
                                                <div class="flex items-center justify-between">
                                                    <p class="font-medium text-gray-900" x-text="m.module_name"></p>
                                                    <span class="text-xs text-gray-500" x-text="m.analysis_framework"></span>
                                                </div>
                                                <div class="mt-2 text-sm">
                                                    <p class="text-gray-600 mb-1"><strong>å…³é”®é—®é¢˜:</strong></p>
                                                    <ul class="ml-4 space-y-1">
                                                        <template x-for="(q, j) in m.key_questions || []" :key="j">
                                                            <li class="text-gray-700" x-text="'â€¢ ' + q"></li>
                                                        </template>
                                                    </ul>
                                                </div>
                                                <div class="mt-2 flex flex-wrap gap-1">
                                                    <template x-for="(s, j) in m.search_queries || []" :key="j">
                                                        <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs" x-text="s"></span>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- æƒ…æ™¯åˆ†æ -->
                                <div x-show="assessment?.research_plan?.scenario_analysis">
                                    <p class="font-medium text-gray-700 mb-2">ğŸ“ˆ æƒ…æ™¯åˆ†æ</p>
                                    <div class="grid grid-cols-3 gap-2 text-sm">
                                        <div class="p-2 bg-green-50 rounded">
                                            <p class="font-medium text-green-700">ä¹è§‚</p>
                                            <p class="text-green-600 text-xs" x-text="assessment?.research_plan?.scenario_analysis?.bull_case || 'â€”'"></p>
                                        </div>
                                        <div class="p-2 bg-gray-50 rounded">
                                            <p class="font-medium text-gray-700">åŸºå‡†</p>
                                            <p class="text-gray-600 text-xs" x-text="assessment?.research_plan?.scenario_analysis?.base_case || 'â€”'"></p>
                                        </div>
                                        <div class="p-2 bg-red-50 rounded">
                                            <p class="font-medium text-red-700">æ‚²è§‚</p>
                                            <p class="text-red-600 text-xs" x-text="assessment?.research_plan?.scenario_analysis?.bear_case || 'â€”'"></p>
                                        </div>
                                    </div>
                                </div>

                                <!-- å†³ç­–æ¡†æ¶ -->
                                <div x-show="assessment?.research_plan?.decision_framework">
                                    <p class="font-medium text-gray-700 mb-2">ğŸ¯ å†³ç­–æ¡†æ¶</p>
                                    <div class="text-sm space-y-1 p-3 bg-yellow-50 rounded-lg">
                                        <p><strong class="text-green-700">æ”¯æŒè®ºç‚¹ â†’</strong> <span class="text-gray-700" x-text="assessment?.research_plan?.decision_framework?.if_research_confirms_thesis"></span></p>
                                        <p><strong class="text-yellow-700">å‰Šå¼±è®ºç‚¹ â†’</strong> <span class="text-gray-700" x-text="assessment?.research_plan?.decision_framework?.if_research_weakens_thesis"></span></p>
                                        <p><strong class="text-red-700">å¦å®šè®ºç‚¹ â†’</strong> <span class="text-gray-700" x-text="assessment?.research_plan?.decision_framework?.if_research_invalidates_thesis"></span></p>
                                    </div>
                                </div>

                                <!-- ä¼˜å…ˆçº§ -->
                                <div x-show="assessment?.research_plan?.priority_ranking?.length > 0">
                                    <p class="font-medium text-gray-700 mb-2">ğŸ“Œ ç ”ç©¶ä¼˜å…ˆçº§</p>
                                    <ol class="text-sm space-y-1">
                                        <template x-for="(p, i) in assessment?.research_plan?.priority_ranking || []" :key="i">
                                            <li class="flex items-center space-x-2">
                                                <span class="w-5 h-5 rounded-full bg-blue-600 text-white text-xs flex items-center justify-center" x-text="i + 1"></span>
                                                <span class="text-gray-700" x-text="p"></span>
                                            </li>
                                        </template>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <!-- äº’åŠ¨å¼ä¿®æ”¹ç ”ç©¶è®¡åˆ’ -->
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <h4 class="font-medium text-yellow-800 mb-2">ğŸ’¬ è°ƒæ•´ç ”ç©¶è®¡åˆ’</h4>
                            <p class="text-sm text-yellow-700 mb-3">å¦‚æœä½ å¯¹ç ”ç©¶è®¡åˆ’æœ‰è°ƒæ•´æ„è§ï¼Œè¯·åœ¨ä¸‹æ–¹æè¿°ï¼Œæˆ‘ä¼šå¸®ä½ ä¿®æ”¹ï¼š</p>
                            <div class="flex space-x-2">
                                <textarea x-model="planAdjustment"
                                    class="flex-1 p-3 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 bg-white resize-none"
                                    placeholder="ä¾‹å¦‚ï¼šå¢åŠ å¯¹ç«äº‰å¯¹æ‰‹çš„åˆ†æã€é‡ç‚¹å…³æ³¨è´¢åŠ¡æ•°æ®ã€åŠ å…¥æŠ€æœ¯è·¯çº¿éªŒè¯...ï¼ˆæ”¯æŒå¤šè¡Œï¼ŒCtrl+Enter å‘é€ï¼‰"
                                    rows="2"
                                    @keydown.ctrl.enter="adjustPlan()"
                                    @keydown.meta.enter="adjustPlan()"></textarea>
                                <button @click="adjustPlan()"
                                    :disabled="!planAdjustment.trim()"
                                    class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 disabled:opacity-50 self-end">
                                    è°ƒæ•´è®¡åˆ’
                                </button>
                            </div>
                            <!-- è°ƒæ•´å†å² -->
                            <div x-show="planAdjustmentHistory.length > 0" class="mt-3 space-y-2">
                                <template x-for="(adj, i) in planAdjustmentHistory" :key="i">
                                    <div class="text-sm p-2 bg-white rounded border border-yellow-200">
                                        <p class="text-yellow-800"><strong>ä½ çš„æ„è§:</strong> <span x-text="adj.request"></span></p>
                                        <p class="text-green-700 mt-1"><strong>å·²è°ƒæ•´:</strong> <span x-text="adj.response"></span></p>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div class="flex space-x-3">
                            <button @click="currentStep = 0" class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                                è¿”å›ä¿®æ”¹å‚æ•°
                            </button>
                            <button @click="executeResearch()"
                                class="flex-1 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                                âœ“ ç¡®è®¤è®¡åˆ’ï¼Œæ‰§è¡Œç ”ç©¶
                            </button>
                        </div>
                    </div>

                    <!-- Step 4: ç ”ç©¶ç»“æœ -->
                    <div x-show="!loading && currentStep === 3" class="space-y-6">
                        <!-- å› æœé€»è¾‘ 3: ä¸ºä»€ä¹ˆä¼šå¾—å‡ºè¿™æ ·çš„ Deep Research ç»“æœï¼Ÿ -->
                        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                            <h3 class="font-medium text-amber-900 mb-3">ğŸ’¡ Step 3 å› æœé€»è¾‘ï¼šä¸ºä»€ä¹ˆä¼šå¾—å‡ºè¿™ä¸ªç ”ç©¶ç»“è®ºï¼Ÿ</h3>

                            <div class="space-y-4 text-sm">
                                <!-- ç ”ç©¶è¾“å…¥ -->
                                <div class="p-3 bg-white rounded-lg border-l-4 border-blue-400">
                                    <p class="font-medium text-blue-800 mb-2">ğŸ“¥ ç ”ç©¶è¾“å…¥ï¼šæˆ‘ä»¬ç ”ç©¶äº†ä»€ä¹ˆï¼Ÿ</p>
                                    <div class="space-y-1">
                                        <p class="text-gray-700">
                                            <span class="text-blue-500 mr-2">â€¢</span>
                                            <strong>ç ”ç©¶ç›®æ ‡ï¼š</strong>
                                            <span x-text="assessment?.research_plan?.research_objective || 'æ·±å…¥åˆ†æè¯¥è‚¡ç¥¨çš„æŠ•èµ„ä»·å€¼'"></span>
                                        </p>
                                        <p class="text-gray-700">
                                            <span class="text-blue-500 mr-2">â€¢</span>
                                            <strong>ç ”ç©¶æ¨¡å—ï¼š</strong>
                                            <span x-text="(assessment?.research_plan?.research_modules || []).map(m => m.module_name).join('ã€') || 'ç»¼åˆåˆ†æ'"></span>
                                        </p>
                                        <p class="text-gray-700">
                                            <span class="text-blue-500 mr-2">â€¢</span>
                                            <strong>æ•°æ®èŒƒå›´ï¼š</strong>
                                            è¿‡å» <span x-text="days"></span> å¤©å†…çš„ <span x-text="news.length"></span> æ¡å¸‚åœºåŠ¨æ€
                                        </p>
                                    </div>
                                </div>

                                <!-- å…³é”®å‘ç° -->
                                <div class="p-3 bg-white rounded-lg border-l-4 border-purple-400">
                                    <p class="font-medium text-purple-800 mb-2">ğŸ” å…³é”®å‘ç°ï¼šç ”ç©¶å‘ç°äº†ä»€ä¹ˆï¼Ÿ</p>
                                    <template x-if="researchResult?.key_findings && researchResult?.key_findings.length > 0">
                                        <div class="space-y-1">
                                            <template x-for="(finding, i) in researchResult?.key_findings?.slice(0, 3) || []" :key="i">
                                                <p class="text-gray-700">
                                                    <span class="text-purple-500 mr-2">â†’</span>
                                                    <span x-text="finding"></span>
                                                </p>
                                            </template>
                                        </div>
                                    </template>
                                    <template x-if="!researchResult?.key_findings || researchResult?.key_findings.length === 0">
                                        <p class="text-gray-600" x-text="researchResult?.conclusion?.key_finding || 'è¯¦è§å®Œæ•´ç ”ç©¶æŠ¥å‘Š'"></p>
                                    </template>
                                </div>

                                <!-- å‡è®¾éªŒè¯ -->
                                <div x-show="assessment?.research_plan?.hypothesis_to_test?.length > 0" class="p-3 bg-white rounded-lg border-l-4 border-green-400">
                                    <p class="font-medium text-green-800 mb-2">ğŸ§ª å‡è®¾éªŒè¯ï¼šä¹‹å‰çš„å‡è®¾éªŒè¯ç»“æœå¦‚ä½•ï¼Ÿ</p>
                                    <div class="space-y-2">
                                        <template x-for="(h, i) in assessment?.research_plan?.hypothesis_to_test?.slice(0, 2) || []" :key="i">
                                            <div class="text-gray-700">
                                                <p><span class="text-green-500 mr-2">â€¢</span><strong>å‡è®¾ï¼š</strong><span x-text="h.hypothesis"></span></p>
                                                <p class="pl-5 text-gray-500 text-xs">ï¼ˆéªŒè¯æ–¹æ³•ï¼š<span x-text="h.how_to_verify"></span>ï¼‰</p>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- æ¨ç†é“¾æ¡ -->
                                <div class="p-3 bg-white rounded-lg border-l-4 border-orange-400">
                                    <p class="font-medium text-orange-800 mb-2">ğŸ”— æ¨ç†é“¾æ¡ï¼šå¦‚ä½•å¾—å‡ºç»“è®ºï¼Ÿ</p>
                                    <div class="space-y-2">
                                        <div class="flex items-start">
                                            <span class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-700 text-xs flex items-center justify-center mr-2">1</span>
                                            <p class="text-gray-700">
                                                <strong>ç¯å¢ƒå˜åŒ–ï¼š</strong>
                                                <span x-text="(assessment?.dimension_analysis?.environment_signals?.signal_vs_noise || []).filter(x => x.classification === 'ä¿¡å·').slice(0, 2).map(s => s.event).join('ï¼›') || 'å¸‚åœºå‡ºç°æ–°çš„å˜åŒ–'"></span>
                                            </p>
                                        </div>
                                        <div class="flex items-start">
                                            <span class="flex-shrink-0 w-6 h-6 rounded-full bg-purple-100 text-purple-700 text-xs flex items-center justify-center mr-2">2</span>
                                            <p class="text-gray-700">
                                                <strong>è®ºç‚¹å½±å“ï¼š</strong>
                                                è¿™äº›å˜åŒ–å¯¹æ ¸å¿ƒè®ºç‚¹çš„å½±å“æ˜¯ã€Œ<span class="font-medium" x-text="assessment?.dimension_analysis?.thesis_impact?.core_thesis_status || 'å¾…è¯„ä¼°'"></span>ã€
                                            </p>
                                        </div>
                                        <div class="flex items-start">
                                            <span class="flex-shrink-0 w-6 h-6 rounded-full bg-green-100 text-green-700 text-xs flex items-center justify-center mr-2">3</span>
                                            <p class="text-gray-700">
                                                <strong>é£é™©/æœºä¼šï¼š</strong>
                                                ä¸»è¦é£é™©æ˜¯ã€Œ<span x-text="assessment?.conclusion?.key_risk || 'æ— æ˜æ˜¾é£é™©'"></span>ã€ï¼Œ
                                                ä¸»è¦æœºä¼šæ˜¯ã€Œ<span x-text="assessment?.conclusion?.key_opportunity || 'æ— æ˜æ˜¾æœºä¼š'"></span>ã€
                                            </p>
                                        </div>
                                        <div class="flex items-start">
                                            <span class="flex-shrink-0 w-6 h-6 rounded-full bg-orange-100 text-orange-700 text-xs flex items-center justify-center mr-2">4</span>
                                            <p class="text-gray-700">
                                                <strong>ç»¼åˆåˆ¤æ–­ï¼š</strong>
                                                <span x-text="researchResult?.conclusion?.reasoning || 'åŸºäºä»¥ä¸Šåˆ†æå¾—å‡ºç»“è®º'"></span>
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- ç»“è®º -->
                                <div class="p-3 bg-amber-100 rounded-lg">
                                    <p class="text-amber-800">
                                        <strong>å› æ­¤ï¼ŒAI å»ºè®®ï¼š</strong>
                                        <span class="font-bold text-lg" x-text="researchResult?.conclusion?.recommendation || 'â€”'"></span>
                                        ï¼ˆä¿¡å¿ƒï¼š<span x-text="researchResult?.conclusion?.confidence || 'â€”'"></span>ï¼‰
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- ========== 30 ç§’æ‘˜è¦å¡ç‰‡ ========== -->
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl shadow-lg text-white p-5">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-3">
                                        <span class="text-xl">&#9889;</span>
                                        <h3 class="text-lg font-bold">30 ç§’æ‘˜è¦</h3>
                                    </div>

                                    <div class="space-y-3">
                                        <!-- æ ¸å¿ƒå˜åŒ– -->
                                        <div class="flex items-start space-x-3">
                                            <span class="flex-shrink-0 w-6 h-6 rounded-full bg-white/20 flex items-center justify-center text-xs">1</span>
                                            <div>
                                                <p class="text-white/70 text-xs mb-0.5">æ ¸å¿ƒå˜åŒ–</p>
                                                <p class="font-medium" x-text="researchResult?.conclusion?.key_finding || assessment?.conclusion?.summary || 'â€”'"></p>
                                            </div>
                                        </div>

                                        <!-- è®ºç‚¹å½±å“ -->
                                        <div class="flex items-start space-x-3">
                                            <span class="flex-shrink-0 w-6 h-6 rounded-full bg-white/20 flex items-center justify-center text-xs">2</span>
                                            <div>
                                                <p class="text-white/70 text-xs mb-0.5">è®ºç‚¹å½±å“</p>
                                                <p class="font-medium">
                                                    <span class="px-2 py-0.5 rounded-full text-xs"
                                                          :class="{
                                                              'bg-green-400/30': researchResult?.conclusion?.thesis_impact === 'å¼ºåŒ–',
                                                              'bg-red-400/30': researchResult?.conclusion?.thesis_impact === 'åŠ¨æ‘‡',
                                                              'bg-yellow-400/30': researchResult?.conclusion?.thesis_impact === 'å‰Šå¼±',
                                                              'bg-white/20': true
                                                          }"
                                                          x-text="researchResult?.conclusion?.thesis_impact || assessment?.dimension_analysis?.thesis_impact?.core_thesis_status || 'æ— æ˜æ˜¾å½±å“'"></span>
                                                </p>
                                            </div>
                                        </div>

                                        <!-- å»ºè®®æ“ä½œ -->
                                        <div class="flex items-start space-x-3">
                                            <span class="flex-shrink-0 w-6 h-6 rounded-full bg-white/20 flex items-center justify-center text-xs">3</span>
                                            <div>
                                                <p class="text-white/70 text-xs mb-0.5">å»ºè®®æ“ä½œ</p>
                                                <p class="font-bold text-xl" x-text="researchResult?.conclusion?.recommendation || 'â€”'"></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ä¿¡å¿ƒæŒ‡æ ‡ -->
                                <div class="flex-shrink-0 text-center px-6 py-3 bg-white/10 rounded-lg ml-4">
                                    <p class="text-white/70 text-xs mb-1">ä¿¡å¿ƒ</p>
                                    <p class="text-3xl font-bold" x-text="researchResult?.conclusion?.confidence || 'â€”'"></p>
                                </div>
                            </div>

                            <!-- åº”ç”¨çš„åå¥½è§„åˆ™ -->
                            <div x-data="{ appliedPrefs: [] }"
                                 x-init="fetch('/api/preferences').then(r => r.json()).then(d => appliedPrefs = (d.preferences || []).filter(p => p.active).slice(0, 3))"
                                 x-show="appliedPrefs.length > 0"
                                 class="mt-4 pt-4 border-t border-white/20">
                                <div class="flex items-start space-x-2">
                                    <span class="text-sm">&#128161;</span>
                                    <div class="flex-1">
                                        <p class="text-white/70 text-xs mb-2">æœ¬æ¬¡åˆ†æè€ƒè™‘äº†æ‚¨çš„åå¥½ï¼š</p>
                                        <div class="flex flex-wrap gap-2">
                                            <template x-for="pref in appliedPrefs" :key="pref.id">
                                                <span class="text-xs px-2 py-1 bg-white/20 rounded-full">
                                                    å½“ã€Œ<span x-text="pref.trigger?.slice(0, 15) + (pref.trigger?.length > 15 ? '...' : '')"></span>ã€æ—¶
                                                    â†’ <span x-text="pref.my_response?.slice(0, 15) + (pref.my_response?.length > 15 ? '...' : '')"></span>
                                                </span>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ========== ç ”ç©¶æ¦‚è¦æ€»ç»“ ========== -->
                        <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                            <!-- æ ¸å¿ƒç»“è®ºå¤´éƒ¨ -->
                            <div class="p-5"
                                 :class="researchResult?.conclusion?.recommendation === 'ä¹°å…¥' || researchResult?.conclusion?.recommendation === 'å¢æŒ' ? 'bg-gradient-to-r from-green-50 to-green-100' :
                                         researchResult?.conclusion?.recommendation === 'å–å‡º' || researchResult?.conclusion?.recommendation === 'å‡æŒ' ? 'bg-gradient-to-r from-red-50 to-red-100' : 'bg-gradient-to-r from-blue-50 to-blue-100'">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-4">
                                        <div class="text-center">
                                            <p class="text-xs text-gray-500 uppercase tracking-wide">AI å»ºè®®</p>
                                            <p class="text-3xl font-bold"
                                               :class="researchResult?.conclusion?.recommendation === 'ä¹°å…¥' || researchResult?.conclusion?.recommendation === 'å¢æŒ' ? 'text-green-700' :
                                                       researchResult?.conclusion?.recommendation === 'å–å‡º' || researchResult?.conclusion?.recommendation === 'å‡æŒ' ? 'text-red-700' : 'text-blue-700'"
                                               x-text="researchResult?.conclusion?.recommendation || 'â€”'"></p>
                                        </div>
                                        <div class="h-12 w-px bg-gray-300"></div>
                                        <div class="text-center">
                                            <p class="text-xs text-gray-500 uppercase tracking-wide">ä¿¡å¿ƒæ°´å¹³</p>
                                            <p class="text-2xl font-semibold text-gray-800" x-text="researchResult?.conclusion?.confidence || 'â€”'"></p>
                                        </div>
                                        <div x-show="researchResult?.conclusion?.position_suggestion" class="h-12 w-px bg-gray-300"></div>
                                        <div x-show="researchResult?.conclusion?.position_suggestion" class="text-center">
                                            <p class="text-xs text-gray-500 uppercase tracking-wide">ä»“ä½å»ºè®®</p>
                                            <p class="text-lg font-medium text-gray-700" x-text="researchResult?.conclusion?.position_suggestion || ''"></p>
                                        </div>
                                    </div>
                                    <div class="text-right max-w-md">
                                        <p class="text-gray-700 text-sm leading-relaxed" x-text="researchResult?.conclusion?.reasoning || ''"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- æ¦‚è¦å†…å®¹åŒº -->
                            <div class="p-5 space-y-5">
                                <!-- å…³é”®å‘ç° -->
                                <div>
                                    <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                                        <span class="w-6 h-6 rounded-full bg-purple-100 text-purple-700 text-xs flex items-center justify-center mr-2">1</span>
                                        å…³é”®å‘ç°
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <template x-for="(finding, i) in (researchResult?.key_findings || []).slice(0, 4)" :key="i">
                                            <div class="flex items-start space-x-2 p-3 bg-gray-50 rounded-lg">
                                                <span class="text-purple-500 mt-0.5">â–¸</span>
                                                <p class="text-sm text-gray-700" x-text="finding"></p>
                                            </div>
                                        </template>
                                        <template x-if="!researchResult?.key_findings || researchResult?.key_findings.length === 0">
                                            <div class="flex items-start space-x-2 p-3 bg-gray-50 rounded-lg col-span-2">
                                                <span class="text-purple-500 mt-0.5">â–¸</span>
                                                <p class="text-sm text-gray-700" x-text="researchResult?.conclusion?.key_finding || 'è¯¦è§å®Œæ•´æŠ¥å‘Š'"></p>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- é£é™©ä¸æœºä¼š -->
                                <div>
                                    <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                                        <span class="w-6 h-6 rounded-full bg-blue-100 text-blue-700 text-xs flex items-center justify-center mr-2">2</span>
                                        é£é™©ä¸æœºä¼š
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <!-- é£é™© -->
                                        <div class="bg-red-50 border border-red-100 rounded-lg p-4">
                                            <p class="text-xs font-medium text-red-600 uppercase tracking-wide mb-2">âš ï¸ ä¸»è¦é£é™©</p>
                                            <ul class="space-y-2">
                                                <template x-for="(risk, i) in (researchResult?.conclusion?.key_risks || []).slice(0, 3)" :key="i">
                                                    <li class="flex items-start space-x-2 text-sm text-red-800">
                                                        <span class="text-red-400">â€¢</span>
                                                        <span x-text="risk"></span>
                                                    </li>
                                                </template>
                                                <template x-if="!researchResult?.conclusion?.key_risks || researchResult?.conclusion?.key_risks.length === 0">
                                                    <li class="text-sm text-red-700" x-text="assessment?.conclusion?.key_risk || 'æš‚æ— æ˜æ˜¾é£é™©'"></li>
                                                </template>
                                            </ul>
                                        </div>
                                        <!-- æœºä¼š/å‚¬åŒ–å‰‚ -->
                                        <div class="bg-green-50 border border-green-100 rounded-lg p-4">
                                            <p class="text-xs font-medium text-green-600 uppercase tracking-wide mb-2">ğŸ¯ å‚¬åŒ–å‰‚/æœºä¼š</p>
                                            <ul class="space-y-2">
                                                <template x-for="(catalyst, i) in (researchResult?.conclusion?.key_catalysts || []).slice(0, 3)" :key="i">
                                                    <li class="flex items-start space-x-2 text-sm text-green-800">
                                                        <span class="text-green-400">â€¢</span>
                                                        <span x-text="catalyst"></span>
                                                    </li>
                                                </template>
                                                <template x-if="!researchResult?.conclusion?.key_catalysts || researchResult?.conclusion?.key_catalysts.length === 0">
                                                    <li class="text-sm text-green-700" x-text="assessment?.conclusion?.key_opportunity || 'æš‚æ— æ˜æ˜¾å‚¬åŒ–å‰‚'"></li>
                                                </template>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- æƒ…æ™¯åˆ†ææ¦‚è¦ -->
                                <div x-show="researchResult?.conclusion?.bull_case_probability || researchResult?.conclusion?.base_case_probability">
                                    <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                                        <span class="w-6 h-6 rounded-full bg-orange-100 text-orange-700 text-xs flex items-center justify-center mr-2">3</span>
                                        æƒ…æ™¯åˆ†æ
                                    </h4>
                                    <div class="flex items-center space-x-2">
                                        <!-- ä¹è§‚ -->
                                        <div class="flex-1 text-center p-3 bg-green-50 rounded-lg">
                                            <p class="text-xs text-green-600 font-medium">ä¹è§‚æƒ…æ™¯</p>
                                            <p class="text-2xl font-bold text-green-700" x-text="(researchResult?.conclusion?.bull_case_probability || 0) + '%'"></p>
                                        </div>
                                        <!-- åŸºå‡† -->
                                        <div class="flex-1 text-center p-3 bg-gray-100 rounded-lg border-2 border-gray-300">
                                            <p class="text-xs text-gray-600 font-medium">åŸºå‡†æƒ…æ™¯</p>
                                            <p class="text-2xl font-bold text-gray-700" x-text="(researchResult?.conclusion?.base_case_probability || 0) + '%'"></p>
                                        </div>
                                        <!-- æ‚²è§‚ -->
                                        <div class="flex-1 text-center p-3 bg-red-50 rounded-lg">
                                            <p class="text-xs text-red-600 font-medium">æ‚²è§‚æƒ…æ™¯</p>
                                            <p class="text-2xl font-bold text-red-700" x-text="(researchResult?.conclusion?.bear_case_probability || 0) + '%'"></p>
                                        </div>
                                    </div>
                                </div>

                                <!-- åç»­è·Ÿè¸ª -->
                                <div x-show="researchResult?.conclusion?.follow_up_items?.length > 0 || researchResult?.conclusion?.next_research_trigger?.length > 0">
                                    <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                                        <span class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-700 text-xs flex items-center justify-center mr-2">4</span>
                                        åç»­è·Ÿè¸ª
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div x-show="researchResult?.conclusion?.follow_up_items?.length > 0" class="p-3 bg-indigo-50 rounded-lg">
                                            <p class="text-xs font-medium text-indigo-600 mb-2">ğŸ“‹ æŒç»­è·Ÿè¸ªäº‹é¡¹</p>
                                            <ul class="space-y-1">
                                                <template x-for="(item, i) in (researchResult?.conclusion?.follow_up_items || []).slice(0, 3)" :key="i">
                                                    <li class="text-sm text-indigo-800 flex items-start">
                                                        <span class="text-indigo-400 mr-2">â€¢</span>
                                                        <span x-text="item"></span>
                                                    </li>
                                                </template>
                                            </ul>
                                        </div>
                                        <div x-show="researchResult?.conclusion?.next_research_trigger?.length > 0" class="p-3 bg-yellow-50 rounded-lg">
                                            <p class="text-xs font-medium text-yellow-600 mb-2">ğŸ”” ä¸‹æ¬¡ç ”ç©¶è§¦å‘æ¡ä»¶</p>
                                            <ul class="space-y-1">
                                                <template x-for="(trigger, i) in (researchResult?.conclusion?.next_research_trigger || []).slice(0, 3)" :key="i">
                                                    <li class="text-sm text-yellow-800 flex items-start">
                                                        <span class="text-yellow-400 mr-2">â€¢</span>
                                                        <span x-text="trigger"></span>
                                                    </li>
                                                </template>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å®Œæ•´æŠ¥å‘Šï¼ˆå¯æŠ˜å ï¼‰ -->
                        <div class="bg-white border border-gray-200 rounded-lg">
                            <div class="p-4 border-b border-gray-200 flex items-center justify-between cursor-pointer hover:bg-gray-50"
                                 @click="reportExpanded = !reportExpanded">
                                <h3 class="font-medium text-gray-900 flex items-center">
                                    <span class="mr-2">ğŸ“„</span>
                                    å®Œæ•´ç ”ç©¶æŠ¥å‘Š
                                    <span class="ml-2 text-xs text-gray-400">ï¼ˆç‚¹å‡»å±•å¼€æŸ¥çœ‹è¯¦ç»†åˆ†æï¼‰</span>
                                </h3>
                                <span class="text-gray-400 transition-transform" :class="reportExpanded ? 'rotate-180' : ''">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </span>
                            </div>
                            <div x-show="reportExpanded" x-collapse class="p-4 max-h-[600px] overflow-y-auto">
                                <div class="prose prose-sm max-w-none" x-html="marked.parse(researchResult?.full_report || '')"></div>
                            </div>
                        </div>

                        <!-- å¯¹è¯å¼ç»§ç»­ç ”ç©¶ -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-medium text-blue-900 mb-2">ğŸ’¬ ç»§ç»­æ·±å…¥ç ”ç©¶</h4>
                            <p class="text-sm text-blue-700 mb-3">å¯¹ç ”ç©¶ç»“æœæœ‰ç–‘é—®ï¼Ÿæƒ³æ·±å…¥æŸä¸ªæ–¹å‘ï¼Ÿç›´æ¥è¾“å…¥ä½ çš„é—®é¢˜ï¼š</p>

                            <!-- å¯¹è¯å†å² -->
                            <div x-show="conversationHistory.length > 0" class="mb-4 max-h-64 overflow-y-auto space-y-3">
                                <template x-for="(msg, i) in conversationHistory" :key="i">
                                    <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                                        <div :class="msg.role === 'user'
                                            ? 'bg-blue-600 text-white rounded-2xl rounded-tr-none max-w-[85%]'
                                            : 'bg-white border border-gray-200 text-gray-900 rounded-2xl rounded-tl-none max-w-[85%]'"
                                            class="px-4 py-3">
                                            <div class="prose prose-sm max-w-none"
                                                 :class="msg.role === 'user' ? 'text-white' : ''"
                                                 x-html="marked.parse(msg.content)"></div>
                                        </div>
                                    </div>
                                </template>
                            </div>

                            <!-- è¾“å…¥æ¡† -->
                            <div class="flex space-x-2">
                                <textarea x-model="followUpQuestion"
                                    class="flex-1 p-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white resize-none"
                                    placeholder="ä¾‹å¦‚ï¼šå¸®æˆ‘å†åˆ†æä¸€ä¸‹ç«äº‰å¯¹æ‰‹çš„æƒ…å†µã€è¿™ä¸ªé£é™©ç‚¹èƒ½å¦é‡åŒ–...ï¼ˆæ”¯æŒå¤šè¡Œï¼ŒCtrl+Enter å‘é€ï¼‰"
                                    rows="2"
                                    @keydown.ctrl.enter="askFollowUp()"
                                    @keydown.meta.enter="askFollowUp()"
                                    :disabled="loading"></textarea>
                                <button @click="askFollowUp()"
                                    :disabled="!followUpQuestion.trim() || loading"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 self-end">
                                    <span x-show="!loading">å‘é€</span>
                                    <span x-show="loading" class="flex items-center">
                                        <svg class="animate-spin h-4 w-4 mr-1" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        æ€è€ƒä¸­
                                    </span>
                                </button>
                            </div>
                        </div>

                        <div class="flex space-x-3">
                            <button @click="currentStep = 2" class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                                è¿”å›æŸ¥çœ‹è®¡åˆ’
                            </button>
                            <button @click="currentStep = 4" class="flex-1 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                                ç ”ç©¶å®Œæˆï¼Œæä¾›åé¦ˆ
                            </button>
                        </div>
                    </div>

                    <!-- Step 5: ç”¨æˆ·åé¦ˆ -->
                    <div x-show="!loading && currentStep === 4" class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="font-medium text-blue-900 mb-2">ğŸ“ è¯·æä¾›ä½ çš„åé¦ˆ</h3>
                            <p class="text-sm text-blue-700">ä½ çš„åé¦ˆå°†ä½œä¸ºä¸‹æ¬¡ç ”ç©¶çš„ä¸Šä¸‹æ–‡å‚è€ƒ</p>
                        </div>

                        <!-- ç ”ç©¶ä»·å€¼è¯„ä¼° -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">1. è¿™ä¸ªç ”ç©¶æ˜¯å¦æœ‰ä»·å€¼ï¼Ÿæ–¹å‘å¯¹ä¸å¯¹ï¼Ÿ</label>
                            <textarea x-model="feedback.feedback_on_research"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                rows="2"
                                placeholder="ä¾‹å¦‚ï¼šç ”ç©¶æ–¹å‘æ­£ç¡®ï¼Œä½†ç¼ºå°‘å¯¹ç«äº‰å¯¹æ‰‹çš„åˆ†æ..."></textarea>
                        </div>

                        <!-- æ˜¯å¦ç»§ç»­ç ”ç©¶ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">2. æ˜¯å¦éœ€è¦ç»§ç»­æ·±å…¥ç ”ç©¶å…¶ä»–æ–¹å‘ï¼Ÿ</label>
                            <div class="flex space-x-4">
                                <label class="flex items-center space-x-2">
                                    <input type="radio" x-model="feedback.needs_further_research" value="no" class="text-blue-600">
                                    <span>ä¸éœ€è¦ï¼Œç ”ç©¶å·²å……åˆ†</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="radio" x-model="feedback.needs_further_research" value="yes" class="text-blue-600">
                                    <span>éœ€è¦ï¼Œæœ‰å…¶ä»–æ–¹å‘</span>
                                </label>
                            </div>
                            <div x-show="feedback.needs_further_research === 'yes'" class="mt-2">
                                <textarea x-model="feedback.further_research_direction"
                                    class="w-full p-3 border border-gray-300 rounded-lg resize-none"
                                    rows="2"
                                    placeholder="è¯·æè¿°éœ€è¦ç»§ç»­ç ”ç©¶çš„æ–¹å‘...ï¼ˆæ”¯æŒå¤šè¡Œè¾“å…¥ï¼‰"></textarea>
                            </div>
                        </div>

                        <!-- æŠ•èµ„å†³ç­– -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">3. åŸºäºè¿™ä¸ªç ”ç©¶ï¼Œä½ çš„æŠ•èµ„å†³ç­–æ˜¯ï¼Ÿ</label>
                            <div class="grid grid-cols-5 gap-2">
                                <button type="button" @click="feedback.final_decision = 'ä¹°å…¥'"
                                    :class="feedback.final_decision === 'ä¹°å…¥' ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                    class="py-2 rounded-lg font-medium transition">ä¹°å…¥</button>
                                <button type="button" @click="feedback.final_decision = 'å¢æŒ'"
                                    :class="feedback.final_decision === 'å¢æŒ' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                    class="py-2 rounded-lg font-medium transition">å¢æŒ</button>
                                <button type="button" @click="feedback.final_decision = 'æŒæœ‰'"
                                    :class="feedback.final_decision === 'æŒæœ‰' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                    class="py-2 rounded-lg font-medium transition">æŒæœ‰</button>
                                <button type="button" @click="feedback.final_decision = 'å‡æŒ'"
                                    :class="feedback.final_decision === 'å‡æŒ' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                    class="py-2 rounded-lg font-medium transition">å‡æŒ</button>
                                <button type="button" @click="feedback.final_decision = 'å–å‡º'"
                                    :class="feedback.final_decision === 'å–å‡º' ? 'bg-red-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                    class="py-2 rounded-lg font-medium transition">å–å‡º</button>
                            </div>
                        </div>

                        <!-- è·Ÿè¸ªæŒ‡æ ‡ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">4. åç»­éœ€è¦æŒç»­è·Ÿè¸ªçš„æŒ‡æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ</label>
                            <div class="flex space-x-2">
                                <input type="text" x-model="newMetric"
                                    class="flex-1 p-3 border border-gray-300 rounded-lg"
                                    placeholder="è¾“å…¥æŒ‡æ ‡ï¼ŒæŒ‰å›è½¦æ·»åŠ "
                                    @keyup.enter="addMetric()">
                                <button @click="addMetric()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">æ·»åŠ </button>
                            </div>
                            <div class="flex flex-wrap gap-2 mt-2">
                                <template x-for="(metric, index) in feedback.tracking_metrics" :key="index">
                                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm flex items-center space-x-1">
                                        <span x-text="metric"></span>
                                        <button @click="removeMetric(index)" class="text-blue-500 hover:text-blue-700">Ã—</button>
                                    </span>
                                </template>
                            </div>
                        </div>

                        <div class="flex space-x-3">
                            <button @click="currentStep = 3" class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                                è¿”å›æŸ¥çœ‹æŠ¥å‘Š
                            </button>
                            <button @click="submitFeedback()"
                                :disabled="!feedback.final_decision"
                                class="flex-1 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium disabled:opacity-50">
                                æäº¤åé¦ˆå¹¶ä¿å­˜
                            </button>
                        </div>
                    </div>

                    <!-- Step 6: å®Œæˆ / ç»§ç»­ç ”ç©¶ -->
                    <div x-show="!loading && currentStep === 5" class="space-y-6">
                        <div class="text-center py-8">
                            <div class="text-6xl mb-4">âœ…</div>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">ç ”ç©¶å·²ä¿å­˜</h3>
                            <p class="text-gray-600">ä½ çš„åé¦ˆå·²è®°å½•ï¼Œå°†ä½œä¸ºä¸‹æ¬¡ç ”ç©¶çš„å‚è€ƒ</p>
                        </div>

                        <div x-show="feedback.needs_further_research === 'yes'" class="p-4 bg-yellow-50 rounded-lg">
                            <p class="text-yellow-800">ä½ æåˆ°éœ€è¦ç»§ç»­ç ”ç©¶: <strong x-text="feedback.further_research_direction"></strong></p>
                            <button @click="continueResearch()" class="mt-3 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                                ç»§ç»­æ·±å…¥ç ”ç©¶è¿™ä¸ªæ–¹å‘
                            </button>
                        </div>

                        <div class="flex space-x-3">
                            <button @click="closeResearchModal(); window.location.reload()" class="flex-1 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                                å®Œæˆ
                            </button>
                            <button @click="startNewResearch()" class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                                å¼€å§‹æ–°çš„ç ”ç©¶
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function stockDetail() {
    return {
        editMode: false,
        jsonContent: JSON.stringify({{ playbook|tojson|safe if playbook else {} }}, null, 2),
        expandedHistory: null,
        stockId: '{{ stock_id }}',

        // ç ”ç©¶ç›¸å…³
        researchModal: false,
        currentStep: 0,
        steps: ['è®¾ç½®å‚æ•°', 'é‡‡é›†ç¯å¢ƒ', 'è¯„ä¼°è®¡åˆ’', 'ç ”ç©¶ç»“æœ', 'æˆ‘çš„åé¦ˆ', 'å®Œæˆ'],
        stepDescriptions: [
            'é€‰æ‹©æ—¶é—´èŒƒå›´å’Œä¸Šä¼ é¢å¤–èµ„æ–™',
            'æ­£åœ¨é‡‡é›†å¸‚åœºåŠ¨æ€...',
            'æŸ¥çœ‹è¯„ä¼°ç»“æœå’Œç ”ç©¶è®¡åˆ’',
            'æŸ¥çœ‹å®Œæ•´ç ”ç©¶æŠ¥å‘Š',
            'æä¾›ä½ çš„åé¦ˆå’Œå†³ç­–',
            'ç ”ç©¶å·²å®Œæˆ'
        ],
        loading: false,
        loadingText: '',
        reportExpanded: false,
        showDimensionDetail: false,

        // å‚æ•°
        days: 7,
        daysPreset: '7',
        uploadedFiles: [],

        // æ•°æ®
        news: [],
        uploadedFilesAnalysis: [],
        searchMetadata: {},  // æœç´¢å…ƒæ•°æ®ï¼ˆåŒ…å«è­¦å‘Šï¼‰
        assessment: null,
        researchResult: null,

        // è®¡åˆ’è°ƒæ•´
        planAdjustment: '',
        planAdjustmentHistory: [],

        // å¯¹è¯å¼ç»§ç»­ç ”ç©¶
        followUpQuestion: '',
        conversationHistory: [],

        // åé¦ˆ
        feedback: {
            feedback_on_research: '',
            needs_further_research: 'no',
            further_research_direction: '',
            final_decision: '',
            tracking_metrics: []
        },
        newMetric: '',

        async savePlaybook() {
            try {
                const data = JSON.parse(this.jsonContent);
                const response = await fetch(`/api/stock/${this.stockId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) window.location.reload();
            } catch (e) {
                alert('JSON æ ¼å¼é”™è¯¯: ' + e.message);
            }
        },

        openResearchModal() {
            this.researchModal = true;
            this.currentStep = 0;
            this.news = [];
            this.assessment = null;
            this.researchResult = null;
            this.showDimensionDetail = false;
            this.planAdjustment = '';
            this.planAdjustmentHistory = [];
            this.followUpQuestion = '';
            this.conversationHistory = [];
            this.feedback = {
                feedback_on_research: '',
                needs_further_research: 'no',
                further_research_direction: '',
                final_decision: '',
                tracking_metrics: []
            };
        },

        closeResearchModal() {
            this.researchModal = false;
        },

        handleFileUpload(event) {
            const files = Array.from(event.target.files);
            this.uploadedFiles = [...this.uploadedFiles, ...files];
        },

        removeFile(index) {
            this.uploadedFiles.splice(index, 1);
        },

        addMetric() {
            if (this.newMetric.trim()) {
                this.feedback.tracking_metrics.push(this.newMetric.trim());
                this.newMetric = '';
            }
        },

        removeMetric(index) {
            this.feedback.tracking_metrics.splice(index, 1);
        },

        async collectEnvironment() {
            this.loading = true;
            this.loadingText = 'æ­£åœ¨é‡‡é›†å¸‚åœºåŠ¨æ€...';
            this.currentStep = 1;

            // ä½¿ç”¨ FormData æ¥ä¸Šä¼ æ–‡ä»¶
            const formData = new FormData();
            formData.append('days', parseInt(this.days));

            // æ·»åŠ ä¸Šä¼ çš„æ–‡ä»¶
            for (const file of this.uploadedFiles) {
                formData.append('files', file);
            }

            const response = await fetch(`/api/research/${this.stockId}/environment`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            // ä¿å­˜ä¸Šä¼ æ–‡ä»¶çš„åˆ†æç»“æœ
            this.uploadedFilesAnalysis = data.uploaded_files_analysis || [];
            this.news = data.news || [];
            this.searchMetadata = data.search_metadata || {};  // æœç´¢å…ƒæ•°æ®ï¼ˆåŒ…å«è­¦å‘Šï¼‰
            this.loading = false;
        },

        async assessImpact() {
            this.loading = true;
            this.loadingText = 'æ­£åœ¨è¿›è¡Œä¸‰ç»´åº¦è¯„ä¼°ï¼Œç”Ÿæˆç ”ç©¶è®¡åˆ’...';

            const response = await fetch(`/api/research/${this.stockId}/assess`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    news: this.news,
                    uploaded_files: this.uploadedFilesAnalysis,
                    time_range: `${this.days}d`
                })
            });

            this.assessment = await response.json();
            this.loading = false;
            this.currentStep = 2;
        },

        async adjustPlan() {
            if (!this.planAdjustment.trim()) return;

            this.loading = true;
            this.loadingText = 'æ­£åœ¨æ ¹æ®ä½ çš„æ„è§è°ƒæ•´ç ”ç©¶è®¡åˆ’...';

            const response = await fetch(`/api/research/${this.stockId}/adjust-plan`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    current_plan: this.assessment?.research_plan,
                    adjustment_request: this.planAdjustment,
                    news: this.news,
                    time_range: `${this.days}d`
                })
            });

            const result = await response.json();

            // è®°å½•è°ƒæ•´å†å²
            this.planAdjustmentHistory.push({
                request: this.planAdjustment,
                response: result.adjustment_summary || 'å·²è°ƒæ•´'
            });

            // æ›´æ–°è®¡åˆ’
            if (result.updated_plan) {
                this.assessment.research_plan = result.updated_plan;
            }

            this.planAdjustment = '';
            this.loading = false;
        },

        async askFollowUp() {
            if (!this.followUpQuestion.trim()) return;

            const question = this.followUpQuestion;
            this.followUpQuestion = '';
            this.conversationHistory.push({ role: 'user', content: question });
            this.loading = true;

            const response = await fetch(`/api/research/${this.stockId}/follow-up`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question: question,
                    research_report: this.researchResult?.full_report,
                    research_conclusion: this.researchResult?.conclusion,
                    conversation_history: this.conversationHistory.slice(0, -1),  // ä¸åŒ…å«åˆšæ·»åŠ çš„é—®é¢˜
                    news: this.news
                })
            });

            const result = await response.json();
            this.conversationHistory.push({ role: 'assistant', content: result.answer });
            this.loading = false;

            // æ»šåŠ¨åˆ°å¯¹è¯åº•éƒ¨
            this.$nextTick(() => {
                const container = document.querySelector('.max-h-64.overflow-y-auto');
                if (container) container.scrollTop = container.scrollHeight;
            });
        },

        async executeResearch() {
            this.loading = true;
            this.loadingText = 'æ­£åœ¨æ‰§è¡Œæ·±åº¦ç ”ç©¶ï¼Œè¿™å¯èƒ½éœ€è¦ 2-3 åˆ†é’Ÿ...';
            this.currentStep = 3;

            const response = await fetch(`/api/research/${this.stockId}/execute`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    research_plan: this.assessment?.research_plan || {},
                    news: this.news,
                    time_range: `${this.days}d`,
                    assessment: this.assessment
                })
            });

            this.researchResult = await response.json();
            this.loading = false;
        },

        async submitFeedback() {
            this.loading = true;
            this.loadingText = 'æ­£åœ¨ä¿å­˜åé¦ˆ...';

            // ä¿å­˜åé¦ˆåˆ°ç ”ç©¶è®°å½•ï¼ˆåŒ…å«å¯¹è¯å†å²ï¼‰
            await fetch(`/api/research/${this.stockId}/feedback`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    feedback: this.feedback,
                    research_result: this.researchResult,
                    conversation_history: this.conversationHistory
                })
            });

            this.loading = false;
            this.currentStep = 5;
        },

        continueResearch() {
            // ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„æ–¹å‘ç»§ç»­ç ”ç©¶
            // ä¿ç•™å½“å‰çš„ç ”ç©¶ç»“æœå’Œå¯¹è¯å†å²ä½œä¸ºä¸Šä¸‹æ–‡
            // å›åˆ°è¯„ä¼°è®¡åˆ’é˜¶æ®µï¼Œä½†ä¿ç•™ news æ•°æ®
            this.currentStep = 1;  // å›åˆ°ç¯å¢ƒé‡‡é›†åçš„çŠ¶æ€
            this.assessment = null;  // æ¸…ç©ºè¯„ä¼°ï¼Œé‡æ–°è¯„ä¼°
            this.planAdjustmentHistory = [];
            // ä¸æ¸…ç©º conversationHistoryï¼Œä¿ç•™å¯¹è¯ä¸Šä¸‹æ–‡
        },

        startNewResearch() {
            this.openResearchModal();
        }
    }
}
</script>
{% endblock %}
