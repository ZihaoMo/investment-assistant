{% extends "base.html" %}

{% block title %}æ·»åŠ è‚¡ç¥¨ - æŠ•èµ„ç ”ç©¶åŠ©æ‰‹{% endblock %}

{% block content %}
<div x-data="socraticInterview()" class="max-w-3xl mx-auto">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="text-center mb-8">
        <h1 class="text-2xl font-bold text-gray-900">æ·»åŠ æ–°è‚¡ç¥¨</h1>
        <p class="text-gray-500 mt-2">é€šè¿‡è‹æ ¼æ‹‰åº•å¼è®¿è°ˆï¼Œå»ºç«‹ä½ çš„æŠ•èµ„é€»è¾‘</p>
    </div>

    <!-- å¼€å§‹ç•Œé¢ -->
    <div x-show="!started" class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 text-center">
        <div class="text-6xl mb-4">ğŸ’¬</div>
        <h2 class="text-xl font-semibold text-gray-900 mb-4">å¼€å§‹è‹æ ¼æ‹‰åº•å¼è®¿è°ˆ</h2>
        <p class="text-gray-500 mb-6">AI åŠ©æ‰‹å°†é€šè¿‡æé—®å¼•å¯¼ä½ æ˜ç¡®æŠ•èµ„é€»è¾‘</p>

        <div class="max-w-md mx-auto mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2 text-left">è‚¡ç¥¨åç§°</label>
            <input type="text" x-model="stockName"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="ä¾‹å¦‚ï¼šè½¯é“¶ã€Circleã€æ’ç„ç§‘æŠ€"
                @keyup.enter="startInterview()">
        </div>

        <button @click="startInterview()"
            :disabled="!stockName.trim()"
            class="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed">
            å¼€å§‹è®¿è°ˆ
        </button>
    </div>

    <!-- å¯¹è¯ç•Œé¢ -->
    <div x-show="started" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <!-- å¤´éƒ¨ -->
        <div class="p-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">ğŸ’¬</span>
                    <div>
                        <h2 class="font-semibold" x-text="'å»ºç«‹ ' + stockName + ' çš„ Playbook'"></h2>
                        <p class="text-blue-100 text-sm">è‹æ ¼æ‹‰åº•å¼è®¿è°ˆè¿›è¡Œä¸­</p>
                    </div>
                </div>
                <span x-show="completed" class="px-3 py-1 bg-green-500 rounded-full text-sm font-medium">
                    âœ“ å®Œæˆ
                </span>
            </div>
        </div>

        <!-- æ¶ˆæ¯åŒºåŸŸ -->
        <div class="h-96 overflow-y-auto p-4 space-y-4" id="chat-messages" x-ref="chatMessages">
            <template x-for="(msg, index) in messages" :key="index">
                <div :class="msg.role === 'assistant' ? 'flex justify-start' : 'flex justify-end'">
                    <div :class="msg.role === 'assistant'
                        ? 'bg-gray-100 text-gray-900 rounded-2xl rounded-tl-none max-w-[80%]'
                        : 'bg-blue-600 text-white rounded-2xl rounded-tr-none max-w-[80%]'"
                        class="px-4 py-3">
                        <div class="prose prose-sm" :class="msg.role === 'assistant' ? '' : 'text-white'"
                             x-html="marked.parse(msg.content)"></div>
                    </div>
                </div>
            </template>

            <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
            <div x-show="loading" class="flex justify-start">
                <div class="bg-gray-100 rounded-2xl rounded-tl-none px-4 py-3">
                    <div class="flex space-x-2">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="p-4 border-t border-gray-200">
            <div x-show="!completed" class="flex space-x-3">
                <textarea x-model="userInput"
                    class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
                    placeholder="è¾“å…¥ä½ çš„å›ç­”...ï¼ˆæ”¯æŒå¤šè¡Œï¼ŒæŒ‰ Ctrl+Enter æˆ–ç‚¹å‡»å‘é€ï¼‰"
                    rows="3"
                    @keydown.ctrl.enter="sendMessage()"
                    @keydown.meta.enter="sendMessage()"
                    :disabled="loading"></textarea>
                <button @click="sendMessage()"
                    :disabled="!userInput.trim() || loading"
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium disabled:opacity-50 self-end">
                    å‘é€
                </button>
            </div>

            <!-- å®Œæˆåçš„æ“ä½œ -->
            <div x-show="completed" class="text-center space-y-4">
                <p class="text-green-600 font-medium">âœ“ Playbook å·²è‡ªåŠ¨ä¿å­˜</p>
                <div class="flex justify-center space-x-3">
                    <a :href="'/stock/' + stockId" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                        æŸ¥çœ‹ Playbook
                    </a>
                    <button @click="reset()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                        æ·»åŠ å¦ä¸€åª
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æç¤º -->
    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
        <h3 class="font-medium text-blue-900 mb-2">ğŸ’¡ è®¿è°ˆè¯´æ˜</h3>
        <ul class="text-sm text-blue-800 space-y-1">
            <li>â€¢ AI ä¼šé€æ­¥æé—®ï¼Œå¸®ä½ æ¢³ç†æŠ•èµ„é€»è¾‘</li>
            <li>â€¢ é—®é¢˜åŒ…æ‹¬ï¼šä¸ºä»€ä¹ˆä¹°ã€æ ¸å¿ƒè®ºç‚¹ã€éªŒè¯ä¿¡å·ã€å¤±æ•ˆæ¡ä»¶ç­‰</li>
            <li>â€¢ å›ç­”å°½é‡å…·ä½“ï¼Œè¿™å°†æˆä¸ºæœªæ¥ç ”ç©¶çš„åŸºç¡€</li>
            <li>â€¢ æ”¯æŒå¤šè¡Œè¾“å…¥ï¼ŒæŒ‰ <kbd class="px-1.5 py-0.5 bg-white rounded border text-xs">Ctrl</kbd>+<kbd class="px-1.5 py-0.5 bg-white rounded border text-xs">Enter</kbd> æˆ–ç‚¹å‡»å‘é€æŒ‰é’®æäº¤</li>
            <li>â€¢ è®¿è°ˆå®Œæˆåï¼ŒPlaybook ä¼šè‡ªåŠ¨ä¿å­˜</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function socraticInterview() {
    return {
        stockName: '',
        started: false,
        completed: false,
        loading: false,
        messages: [],
        userInput: '',
        stockId: '',
        playbook: null,

        async startInterview() {
            if (!this.stockName.trim()) return;

            this.started = true;
            this.loading = true;

            const response = await fetch('/api/interview/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: 'stock',
                    stock_name: this.stockName
                })
            });

            const data = await response.json();
            this.messages.push({ role: 'assistant', content: data.message });
            this.loading = false;
            this.scrollToBottom();
        },

        async sendMessage() {
            if (!this.userInput.trim() || this.loading) return;

            const message = this.userInput;
            this.userInput = '';
            this.messages.push({ role: 'user', content: message });
            this.loading = true;
            this.scrollToBottom();

            try {
                const response = await fetch('/api/interview/continue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'stock',
                        stock_name: this.stockName,
                        message: message
                    })
                });

                const data = await response.json();

                // å¤„ç†é”™è¯¯
                if (data.error) {
                    this.messages.push({ role: 'assistant', content: `âš ï¸ ${data.error}\n\n${data.message || ''}` });
                    this.loading = false;
                    this.scrollToBottom();
                    return;
                }

                this.messages.push({ role: 'assistant', content: data.message });

                // æ˜¾ç¤ºè§£æè­¦å‘Š
                if (data.parse_warning) {
                    this.messages.push({
                        role: 'assistant',
                        content: `âš ï¸ **ç³»ç»Ÿæç¤º**: ${data.parse_warning}`
                    });
                }

                // æ˜¾ç¤ºä¿å­˜é”™è¯¯
                if (data.save_error) {
                    this.messages.push({
                        role: 'assistant',
                        content: `âŒ **ä¿å­˜å¤±è´¥**: ${data.save_error}`
                    });
                }

                if (data.completed && !data.save_error) {
                    this.completed = true;
                    this.playbook = data.playbook;
                    this.stockId = this.stockName.toLowerCase().replace(/ /g, '_');
                }
            } catch (error) {
                this.messages.push({
                    role: 'assistant',
                    content: `âŒ **ç½‘ç»œé”™è¯¯**: è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚`
                });
            }

            this.loading = false;
            this.scrollToBottom();
        },

        scrollToBottom() {
            this.$nextTick(() => {
                const container = this.$refs.chatMessages;
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            });
        },

        reset() {
            this.stockName = '';
            this.started = false;
            this.completed = false;
            this.messages = [];
            this.userInput = '';
            this.stockId = '';
            this.playbook = null;
        }
    }
}
</script>
{% endblock %}
